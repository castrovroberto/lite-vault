# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

## [0.4.0] - 2025-05-01

### Added
- **JWT Secrets Engine (Phase 4 - Tasks 31-40):**
  - Implemented `JwtSecretsEngine` for managing cryptographic keys (RSA, EC) used for signing JWTs (Task 31).
  - Added configuration (`mssm.secrets.jwt.keys`) to define named JWT keys, their types (RSA/EC), size/curve, and optional rotation period (Task 32).
  - Implemented secure key generation and storage. Private keys are encrypted using `EncryptionService` before persistence via `StorageBackend` (Task 33).
  - Implemented key versioning, storing metadata about the current signing key version (Task 34).
  - Added `JwtController` with API endpoints under `/v1/jwt`:
    - `POST /sign/{keyName}`: Signs provided claims using the current version of the specified key. Requires authentication and `WRITE` capability on `jwt/sign/{keyName}` (Task 35).
    - `GET /jwks/{keyName}`: Retrieves the public keys (JWK Set) for the specified key name. Publicly accessible (Task 36).
    - `POST /rotate/{keyName}`: Manually triggers rotation for the specified key. Requires authentication and `WRITE` capability on `jwt/rotate/{keyName}` (Task 37).
  - Integrated audit logging for key generation/rotation, JWT signing, and JWKS access (Task 38).
  - Added unit tests for `JwtSecretsEngine` (Task 39).
  - Added integration tests (`JwtControllerIntegrationTest`, `JwtControllerAuthorizationTest`) for the JWT API endpoints, covering lifecycle, security, and error handling (Task 40).

### Changed
- **Security Configuration:** Updated `SecurityConfig` to allow public access to `/v1/jwt/jwks/**`.
- **Dependencies:** Added `jjwt-api`, `jjwt-impl`, `jjwt-jackson`, and `nimbus-jose-jwt` to `pom.xml` for JWT handling.
- **Testing:** Refactored JWT integration tests into `JwtControllerIntegrationTest` (real engine) and `JwtControllerAuthorizationTest` (mocked engine) for clarity and correctness.

### Fixed
- **Testing:** Resolved issues in `JwtControllerIntegrationTest` where mocked beans were interfering with tests intended to use the real `JwtSecretsEngine`.

### Security
- **JWT Private Key Encryption:** JWT private keys are encrypted at rest using AES-256-GCM via the `EncryptionService`.
- **JWT API Authorization:** The `/v1/jwt/sign/{keyName}` and `/v1/jwt/rotate/{keyName}` endpoints are protected by authentication and require specific policy capabilities (`WRITE` on the respective paths).
- **JWT Audit Logging:** Key management actions (rotation) and usage (signing, JWKS retrieval) are logged for security monitoring.

## [0.3.0] - 2025-04-30

### Added
- **Audit Logging for DB Actions (Task 28):**
  - Injected `AuditBackend` into `DbController` and `PostgresSecretsEngine`.
  - Added audit logging within `DBController` for `GET /v1/db/creds/{rolename}` requests:
    - Logs "success" events including authenticated principal, source IP, request ID, requested role, and generated lease ID.
    - Logs "failure" events in exception handlers (404, 500, 503) including principal, source IP, request ID, requested role, and error message.
  - Added audit logging within `PostgresSecretsEngine`:
    - Logs internal "success" event upon successful lease creation (`lease_creation` action) including lease ID and role name.
    - Logs internal "success" or "failure" events for lease revocation attempts (`revoke_lease` action) including lease ID and error message on failure.
  - Ensured generated passwords are **not** included in any audit logs.
  - Fulfills requirement F-CORE-130 for dynamic secrets.
- **DB Credentials API Endpoint (Task 27):**
  - Created `DbController.java` under the `/v1/db` base path.
  - Implemented the `GET /creds/{roleName}` endpoint to handle requests for dynamic PostgreSQL credentials.
  - The endpoint calls `PostgresSecretsEngine.generateCredentials` using the provided `roleName`.
  - Defined `DbCredentialsResponse` DTO to structure the response containing `leaseId`, `username`, `password`, and `leaseDurationSeconds`.
  - Added exception handlers (`@ExceptionHandler`) in `DbController` to map `RoleNotFoundException` (404), `SecretsEngineException` (500), `VaultSealedException` (503), and general `Exception` (500) to appropriate HTTP error responses using `ProblemDetail`.
  - The endpoint is protected by the existing authentication (`StaticTokenAuthFilter`) and authorization (`PolicyEnforcementFilter`) mechanisms, requiring a token with `READ` capability on the `db/creds/*` path.
- **Basic Lease Management (Task 26):**
  - Added in-memory lease tracking to `PostgresSecretsEngine` using `ConcurrentHashMap<UUID, Lease>`.
  - Leases generated by `generateCredentials` are now stored in the map.
  - Implemented a helper `getLeaseById` to retrieve leases.
  - Implemented the core logic in `revokeLease` to:
    - Look up the lease by ID from the map.
    - Retrieve the associated username and role definition.
    - Prepare and execute the configured `revocationStatements` using `JdbcTemplate`.
    - Remove the lease from the map *only* after successful SQL execution.
  - Includes error handling for missing leases, missing role definitions during revocation, and database errors during revocation.
  - Fulfills initial requirements F-DB-210 and F-DB-230.
- **PostgreSQL Credential Generation (Task 25):**
  - Implemented the `generateCredentials` method in `PostgresSecretsEngine`.
  - Added helper methods for secure password generation (`generatePassword`) and unique username generation (`generateUsername`).
  - Added helper method (`prepareSqlStatements`) to replace `{{username}}` and `{{password}}` placeholders in configured SQL statements.
  - The engine now looks up the role definition from `MssmProperties`, generates credentials, executes the creation SQL using `JdbcTemplate`, and returns a `Lease` object containing the credentials and metadata (TTL, ID, etc.).
  - Includes error handling for missing roles (`RoleNotFoundException`) and database errors (`SecretsEngineException` wrapping `DataAccessException`).
  - Ensured generated passwords are not logged.
- **PostgreSQL Connection Management (Task 24):**
  - Configured Spring Boot's primary `DataSource` via `spring.datasource.*` properties in `application-dev.yml`, referencing `mssm.secrets.db.postgres.*` values to connect to the target database.
  - Injected the auto-configured `JdbcTemplate` into `PostgresSecretsEngine`.
  - Added a `@PostConstruct` connection check (`checkDbConnection`) in `PostgresSecretsEngine` to verify target DB connectivity on startup.
  - Enabled DEBUG logging for `spring-jdbc` and `HikariCP` in `application-dev.yml`.
- **PostgreSQL Engine Configuration (Task 23):**
  - Updated `MssmProperties.java` to include nested configuration records (`SecretsProperties`, `DbSecretsProperties`, `PostgresProperties`, `PostgresRoleDefinition`) under `mssm.secrets.db.postgres`.
  - Added configuration fields for target PostgreSQL connection URL, admin username, and admin password.
  - Added configuration for defining roles as a map (`mssm.secrets.db.postgres.roles`), where each role specifies SQL `creationStatements`, `revocationStatements` (using `{{username}}`/`{{password}}` placeholders), and a `defaultTtl`.
  - Included validation annotations (`@Valid`, `@NotBlank`, etc.) for the new configuration properties.
  - Updated `application-dev.yml` with an example `mssm.secrets.db.postgres` section, including sample roles (`readonly-app-role`, `migrations-role`) and secure password handling via environment variable (`${MSSM_DB_POSTGRES_PASSWORD:...}`).
  - Fulfills requirement F-DB-200.
- **PostgreSQL Secrets Engine Core (Task 22):**
  - Created `PostgresSecretsEngine` class in `tech.yump.vault.secrets.db` package.
  - Implemented the `DynamicSecretsEngine` interface.
  - Added `@Service` annotation for Spring bean registration.
  - Set up constructor injection for `MssmProperties` and `DataSource`.
  - Included placeholder implementations for `generateCredentials` and `revokeLease`.
  - Added `org.postgresql:postgresql` and `org.springframework.boot:spring-boot-starter-jdbc` dependencies to `pom.xml`.
  - This provides the foundational structure for the dynamic PostgreSQL secrets engine.
- **Core Secrets Engine Interfaces (Task 21):**
  - Defined base `SecretsEngine` marker interface.
  - Defined `DynamicSecretsEngine` interface extending `SecretsEngine`, specifying contracts for `generateCredentials` and `revokeLease`.
  - Defined `Lease` record (`java.lang.Record`) to structure data for dynamically generated secrets (ID, TTL, data, timestamps, etc.).
  - Added base exception classes (`SecretsEngineException`, `RoleNotFoundException`, `LeaseNotFoundException`) for secrets engine operations.
  - This establishes a common structure for current (KV) and future (e.g., dynamic DB) secrets engines, enhancing extensibility (NFR-MTN-500).

### Changed
- **KVSecretEngine Interface (Task 21):** Updated `KVSecretEngine` to extend the new base `SecretsEngine` interface for consistency across engine types.

### Fixed
- **Testing (Task 24):** Corrected `MssmProperties` instantiation in `FileSystemStorageBackendTest` to include the `secrets` property, resolving a constructor mismatch caused by Task 23 changes.

### Removed
### Security

## [0.2.0] - 2025-04-29
*(... content from previous 0.2.0 release ...)*

---
<!-- Optional: Add link definitions for comparing versions -->
[Unreleased]: https://github.com/your-username/lite-vault/compare/v0.4.0...HEAD
[0.4.0]: https://github.com/your-username/lite-vault/compare/v0.3.0...v0.4.0
[0.3.0]: https://github.com/your-username/lite-vault/compare/v0.2.0...v0.3.0
[0.2.0]: https://github.com/your-username/lite-vault/releases/tag/v0.2.0
<!-- If you had a v0.1.0 tag, you could compare [0.2.0]: https://github.com/your-username/lite-vault/compare/v0.1.0...v0.2.0 -->